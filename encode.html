<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>高级加密工具 - 国密 & 二维码</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.0.0/crypto-js.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sm-crypto@3.0.1/dist/sm-crypto.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@zxing/library@0.19.1/umd/index.min.js"></script>
  <style>
    body {
      background-color: #1e1e2f;
      color: #dcdcdc;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      padding: 20px;
    }

    h2, h3 {
      color: #ffffff;
    }

    .container {
      max-width: 750px;
      margin: auto;
      background-color: #2a2a3d;
      padding: 25px;
      border-radius: 10px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
    }

    label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }

    input[type="text"],
    textarea,
    input[type="file"],
    select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: none;
      border-radius: 5px;
      background-color: #3c3c54;
      color: #fff;
      resize: vertical;
    }

    button {
      margin-top: 10px;
      padding: 8px 12px;
      font-size: 14px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .btn-green { background-color: #4caf50; color: white; }
    .btn-blue { background-color: #2196f3; color: white; }
    .btn-gray { background-color: #777; color: white; }

    button:hover {
      opacity: 0.9;
    }

    textarea[readonly] {
      background-color: #2f2f44;
      color: #ccc;
    }

    #reader {
      margin-top: 10px;
      width: 100%;
      height: 200px;
      background-color: #000;
    }
  </style>
</head>
<body>

<div class="container">
  <h2>高级加密工具 - 支持 SM2/SM4 / 二维码识别</h2>

  <!-- 模式选择 -->
  <label for="modeSelect">选择加密模式:</label>
  <select id="modeSelect">
    <option value="AES-CBC">AES-CBC</option>
    <option value="AES-GCM">AES-GCM</option>
    <option value="SM2">SM2 (国密非对称)</option>
    <option value="SM4-CBC">SM4-CBC (国密对称)</option>
    <option value="SM4-ECB">SM4-ECB (国密对称)</option>
  </select>

  <!-- 密钥输入 -->
  <label for="inputKey">你的密钥:</label>
  <input type="text" id="inputKey" placeholder="请输入密钥（SM4用16字节，SM2用私钥）" />

  <!-- IV 输入 -->
  <label for="ivInput">手动输入 IV（Hex 格式，可选）:</label>
  <input type="text" id="ivInput" placeholder="如: 70231a8d4cb59c49f0516720e1f79a5b" />

  <!-- 内容输入 -->
  <label for="inputText">原文或密文:</label>
  <textarea id="inputText" rows="4" placeholder="请输入需要加密或解密的内容..."></textarea>

  <!-- 按钮 -->
  <button class="btn-green" onclick="encryptText()">加密</button>
  <button class="btn-blue" onclick="decryptText()">解密</button>
  <button class="btn-gray" onclick="copyResult()">复制结果</button>

  <!-- 二维码识别 -->
  <h3>二维码识别:</h3>
  <input type="file" accept="image/*" onchange="handleImageUpload(event)">
  <div id="reader"></div>

  <!-- 结果输出 -->
  <h3>结果:</h3>
  <textarea id="resultText" rows="4" readonly></textarea>
</div>

<script>
function encryptText() {
  const mode = document.getElementById('modeSelect').value;
  const key = document.getElementById('inputKey').value.trim();
  const iv = document.getElementById('ivInput').value.trim();
  const text = document.getElementById('inputText').value;

  if (!key || !text) {
    alert("请填写密钥和内容");
    return;
  }

  let encrypted;

  switch (mode) {
    case "AES-CBC":
      encrypted = CryptoJS.AES.encrypt(text, CryptoJS.enc.Utf8.parse(key), {
        iv: CryptoJS.enc.Hex.parse(iv || CryptoJS.lib.WordArray.random(16).toString())
      }).toString();
      break;

    case "AES-GCM":
      encrypted = CryptoJS.AES.encrypt(text, CryptoJS.enc.Utf8.parse(key), {
        iv: CryptoJS.enc.Hex.parse(iv || CryptoJS.lib.WordArray.random(12).toString()),
        mode: CryptoJS.mode.GCM,
        tagLength: 128
      }).toString();
      break;

    case "SM2":
      encrypted = sm4.sm2.doEncrypt(text, key); // SM2加密需提供公钥
      break;

    case "SM4-CBC":
      encrypted = sm4.sm4.encrypt(text, key, {
        mode: 'cbc',
        iv: iv
      });
      break;

    case "SM4-ECB":
      encrypted = sm4.sm4.encrypt(text, key, {
        mode: 'ecb'
      });
      break;
  }

  document.getElementById('resultText').value = encrypted;
}

function decryptText() {
  const mode = document.getElementById('modeSelect').value;
  const key = document.getElementById('inputKey').value.trim();
  const iv = document.getElementById('ivInput').value.trim();
  const cipher = document.getElementById('inputText').value;

  if (!key || !cipher) {
    alert("请填写密钥和密文");
    return;
  }

  let decrypted;

  switch (mode) {
    case "AES-CBC":
      decrypted = CryptoJS.AES.decrypt(cipher, CryptoJS.enc.Utf8.parse(key), {
        iv: CryptoJS.enc.Hex.parse(iv)
      }).toString(CryptoJS.enc.Utf8);
      break;

    case "AES-GCM":
      decrypted = CryptoJS.AES.decrypt(cipher, CryptoJS.enc.Utf8.parse(key), {
        iv: CryptoJS.enc.Hex.parse(iv),
        mode: CryptoJS.mode.GCM
      }).toString(CryptoJS.enc.Utf8);
      break;

    case "SM2":
      decrypted = sm4.sm2.doDecrypt(cipher, key); // 需要私钥
      break;

    case "SM4-CBC":
      decrypted = sm4.sm4.decrypt(cipher, key, {
        mode: 'cbc',
        iv: iv
      });
      break;

    case "SM4-ECB":
      decrypted = sm4.sm4.decrypt(cipher, key, {
        mode: 'ecb'
      });
      break;
  }

  document.getElementById('resultText').value = decrypted;
}

function copyResult() {
  const result = document.getElementById('resultText');
  result.select();
  document.execCommand("copy");
  alert("结果已复制到剪贴板！");
}

// === 二维码识别功能 ===
async function handleImageUpload(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = async function(e) {
    const image = new Image();
    image.src = e.target.result;
    image.onload = async () => {
      const codeReader = new ZXing.BrowserQRCodeReader();
      try {
        const result = await codeReader.decodeFromImageElement(image);
        document.getElementById('inputText').value = result.text;
      } catch (err) {
        alert("未检测到二维码：" + err.message);
      }
    };
  };
  reader.readAsDataURL(file);
}
</script>

</body>
</html>
